<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ChaosKey333 Prime Vault</title>
  
  <!-- Payment Gateway SDKs -->
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=PLACEHOLDER_PAYPAL_CLIENT_ID&currency=USD&intent=capture"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  
  <style>
    body {
      background: linear-gradient(135deg, #0d001a 0%, #1a0033 50%, #0d001a 100%);
      color: white;
      font-family: 'Courier New', monospace;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
    }
    
    .vault-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 30px;
      background: rgba(0, 20, 40, 0.8);
      border-radius: 20px;
      border: 2px solid #33ccff;
      box-shadow: 0 0 30px rgba(51, 204, 255, 0.3);
    }
    
    .vault-title {
      font-size: 2.5rem;
      background: linear-gradient(45deg, #ff6600, #33ccff, #ffcc00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      text-shadow: 0 0 20px rgba(255, 204, 0, 0.5);
    }
    
    .prime-badge {
      display: inline-block;
      background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
      color: #000;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      margin: 10px;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
      animation: holographicShimmer 2s infinite;
    }
    
    @keyframes holographicShimmer {
      0%, 100% { transform: scale(1); box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); }
      50% { transform: scale(1.05); box-shadow: 0 0 25px rgba(255, 215, 0, 0.8); }
    }
    
    .wallet-section {
      margin: 30px 0;
      padding: 20px;
      background: rgba(0, 30, 60, 0.5);
      border-radius: 15px;
      border: 1px solid #66ccff;
    }
    
    .payment-gateways {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin: 30px 0;
      flex-wrap: wrap;
    }
    
    .gateway-option {
      flex: 1;
      min-width: 300px;
      max-width: 350px;
      padding: 25px;
      background: rgba(0, 40, 80, 0.6);
      border-radius: 15px;
      border: 2px solid #444;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .gateway-option.prime-default {
      border: 2px solid #ffd700;
      background: rgba(255, 215, 0, 0.1);
      transform: scale(1.02);
    }
    
    .gateway-option:hover {
      transform: scale(1.05);
      border-color: #33ccff;
      box-shadow: 0 0 20px rgba(51, 204, 255, 0.4);
    }
    
    .gateway-title {
      font-size: 1.5rem;
      margin-bottom: 15px;
      font-weight: bold;
    }
    
    .paypal-title {
      color: #ffd700;
    }
    
    .stripe-title {
      color: #6772e5;
    }
    
    .gateway-description {
      font-size: 0.9rem;
      margin-bottom: 20px;
      color: #ccc;
    }
    
    .payment-btn {
      width: 100%;
      padding: 15px 25px;
      font-size: 1.1rem;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    
    .paypal-btn {
      background: linear-gradient(45deg, #ffd700, #ffed4e);
      color: #000;
    }
    
    .paypal-btn:hover {
      background: linear-gradient(45deg, #ffed4e, #ffd700);
      transform: translateY(-2px);
    }
    
    .stripe-btn {
      background: linear-gradient(45deg, #6772e5, #5469d4);
      color: white;
    }
    
    .stripe-btn:hover {
      background: linear-gradient(45deg, #5469d4, #6772e5);
      transform: translateY(-2px);
    }
    
    .status-display {
      margin: 30px 0;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      font-size: 1.1rem;
    }
    
    .pulse-tracker {
      margin-top: 40px;
      padding: 20px;
      background: rgba(0, 20, 40, 0.7);
      border-radius: 15px;
      border: 1px solid #33ccff;
    }
    
    .pulse-stats {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }
    
    .pulse-stat {
      background: rgba(0, 40, 80, 0.8);
      padding: 10px 15px;
      border-radius: 10px;
      border: 1px solid #66ccff;
    }
    
    .hidden {
      display: none;
    }
    
    .auto-mint-notice {
      background: linear-gradient(45deg, #00ff00, #33cc33);
      color: #000;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-weight: bold;
      animation: glow 2s infinite;
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); }
      50% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.8); }
    }
  </style>
</head>
<body>
  <div class="vault-container">
    <h1 class="vault-title">üî• ChaosKey333 Prime Vault üî•</h1>
    <p>Enhanced Payment Experience ‚Ä¢ Prime Vault Keys ‚Ä¢ Auto-Mint Technology</p>
    
    <!-- Prime Badge Display (shows after PayPal payment) -->
    <div id="primeBadge" class="prime-badge hidden">
      ‚≠ê PRIME VAULT KEY HOLDER ‚≠ê
    </div>
    
    <!-- Wallet Connection Section -->
    <div class="wallet-section">
      <h3>üîå Wallet Connection</h3>
      <button id="connectWallet" class="payment-btn">Connect Wallet</button>
      <div id="walletStatus">üîí Please connect your wallet to continue</div>
    </div>
    
    <!-- Dual Gateway Payment Options -->
    <div class="payment-gateways">
      
      <!-- PayPal Prime Gateway (Default/Featured) -->
      <div class="gateway-option prime-default" id="paypalGateway">
        <div class="gateway-title paypal-title">üíé PayPal Prime</div>
        <div class="gateway-description">
          ‚Ä¢ One-click vault checkout<br>
          ‚Ä¢ Earn exclusive Prime Vault Key badge<br>
          ‚Ä¢ Auto-mint on payment success<br>
          ‚Ä¢ Premium vault experience
        </div>
        <div id="paypal-button-container"></div>
        <button id="paypalFallback" class="payment-btn paypal-btn" style="display: none;">
          ü•á Pay with PayPal Prime - $33.33
        </button>
      </div>
      
      <!-- Stripe Gateway -->
      <div class="gateway-option" id="stripeGateway">
        <div class="gateway-title stripe-title">üí≥ Stripe</div>
        <div class="gateway-description">
          ‚Ä¢ Card payment processing<br>
          ‚Ä¢ Secure checkout experience<br>
          ‚Ä¢ Standard vault access<br>
          ‚Ä¢ Reliable payment flow
        </div>
        <button id="stripeBtn" class="payment-btn stripe-btn">
          üí≥ Pay with Card - $33.33
        </button>
      </div>
      
    </div>
    
    <!-- Status Display -->
    <div class="status-display" id="statusDisplay">
      üîí Select payment method to proceed with relic minting
    </div>
    
    <!-- Auto-Mint Notice (shows after successful payment) -->
    <div id="autoMintNotice" class="auto-mint-notice hidden">
      üöÄ Auto-Mint Activated! Your relic is being minted to your connected wallet...
    </div>
    
    <!-- Revenue Pulse Tracker -->
    <div class="pulse-tracker">
      <h3>üìä Vault Broadcast Pulse</h3>
      <div class="pulse-stats" id="pulseStats">
        <div class="pulse-stat">
          <div>Total Transactions</div>
          <div id="totalTx">Loading...</div>
        </div>
        <div class="pulse-stat">
          <div>Prime Transactions</div>
          <div id="primeTx">Loading...</div>
        </div>
        <div class="pulse-stat">
          <div>Total Revenue</div>
          <div id="totalRevenue">Loading...</div>
        </div>
        <div class="pulse-stat">
          <div>Last Pulse</div>
          <div id="lastPulse">Loading...</div>
        </div>
      </div>
    </div>
    
  </div>

  <script>
    // Global variables
    let stripe;
    let paypalButtonsRendered = false;
    let connectedWallet = null;
    let connectedWalletType = null;
    let config = null;

    // Initialize the application
    async function initializeApp() {
      try {
        console.log('üöÄ Initializing ChaosKey333 Prime Vault...');
        
        // Load payment gateway configuration
        const configResponse = await fetch('/config');
        config = await configResponse.json();
        
        console.log('‚öôÔ∏è Gateway config loaded:', config);
        
        // Initialize Stripe if available
        if (config.stripe?.available && config.stripe.publicKey) {
          stripe = Stripe(config.stripe.publicKey);
          console.log('‚úÖ Stripe initialized');
        } else {
          console.warn('‚ö†Ô∏è Stripe not available');
          document.getElementById('stripeGateway').style.display = 'none';
        }
        
        // Initialize PayPal if available
        if (config.paypal?.available && config.paypal.clientId) {
          initializePayPal();
        } else {
          console.warn('‚ö†Ô∏è PayPal not available');
          document.getElementById('paypalGateway').style.display = 'none';
          showStatus('‚ö†Ô∏è PayPal Prime not configured. Using Stripe only.');
        }
        
        // Check for payment success in URL
        checkPaymentSuccess();
        
        // Load pulse tracker data
        loadPulseTracker();
        
        // Refresh pulse data every 30 seconds
        setInterval(loadPulseTracker, 30000);
        
      } catch (error) {
        console.error('‚ùå App initialization failed:', error);
        showStatus('‚ùå Failed to initialize payment gateways');
      }
    }

    // Wallet connection functionality
    async function connectWallet() {
      try {
        if (!window.ethereum) {
          alert('ü¶ä MetaMask not detected. Please install MetaMask or use a Web3 browser.');
          return;
        }

        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        connectedWallet = accounts[0];
        connectedWalletType = 'MetaMask';
        
        document.getElementById('walletStatus').innerHTML = `
          üü¢ Connected: ${connectedWallet.substring(0, 6)}...${connectedWallet.substring(38)}
          <br><small>Type: ${connectedWalletType}</small>
        `;
        
        showStatus('‚úÖ Wallet connected! Select your preferred payment method.');
        
        console.log('‚úÖ Wallet connected:', connectedWallet);
        
      } catch (error) {
        console.error('‚ùå Wallet connection failed:', error);
        showStatus('‚ùå Wallet connection failed. Please try again.');
      }
    }

    // Initialize PayPal buttons
    function initializePayPal() {
      try {
        // Update the script src with actual client ID
        const paypalScript = document.querySelector('script[src*="paypal.com/sdk"]');
        if (paypalScript && config.paypal.clientId !== 'PLACEHOLDER_PAYPAL_CLIENT_ID') {
          paypalScript.src = paypalScript.src.replace('PLACEHOLDER_PAYPAL_CLIENT_ID', config.paypal.clientId);
        }
        
        // Render PayPal buttons
        if (window.paypal && !paypalButtonsRendered) {
          window.paypal.Buttons({
            style: {
              color: 'gold',
              shape: 'rect',
              label: 'pay',
              height: 50
            },
            
            createOrder: async function(data, actions) {
              if (!connectedWallet) {
                alert('üîå Please connect your wallet first');
                throw new Error('Wallet not connected');
              }
              
              showStatus('üü° Creating PayPal Prime order...');
              
              try {
                const response = await fetch('/api/paypal/create-order', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    walletAddress: connectedWallet,
                    connectedWalletType: connectedWalletType,
                    amount: 33.33,
                    productName: 'ChaosKey333 Prime Relic'
                  })
                });
                
                const order = await response.json();
                
                if (order.orderID) {
                  showStatus('‚úÖ PayPal Prime order created! Complete payment to earn Prime Vault Key.');
                  return order.orderID;
                } else {
                  throw new Error('Failed to create order');
                }
                
              } catch (error) {
                console.error('‚ùå Order creation failed:', error);
                showStatus('‚ùå Failed to create PayPal order. Please try again.');
                throw error;
              }
            },
            
            onApprove: async function(data, actions) {
              showStatus('üü° Processing PayPal Prime payment...');
              
              try {
                const response = await fetch('/api/paypal/capture-order', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    orderID: data.orderID,
                    walletAddress: connectedWallet,
                    connectedWalletType: connectedWalletType
                  })
                });
                
                const result = await response.json();
                
                if (result.success) {
                  // Show Prime Badge
                  document.getElementById('primeBadge').classList.remove('hidden');
                  
                  // Show auto-mint notice
                  document.getElementById('autoMintNotice').classList.remove('hidden');
                  
                  showStatus('üéâ PayPal Prime payment successful! Prime Vault Key earned!');
                  
                  // Trigger auto-mint
                  setTimeout(() => {
                    triggerAutoMint('paypal_prime', data.orderID);
                  }, 2000);
                  
                  // Refresh pulse tracker
                  loadPulseTracker();
                  
                } else {
                  throw new Error(result.error || 'Payment capture failed');
                }
                
              } catch (error) {
                console.error('‚ùå Payment capture failed:', error);
                showStatus('‚ùå Payment processing failed. Please contact support.');
              }
            },
            
            onError: function(err) {
              console.error('‚ùå PayPal error:', err);
              showStatus('‚ùå PayPal payment error. Please try again.');
            },
            
            onCancel: function(data) {
              console.log('‚ö†Ô∏è PayPal payment cancelled');
              showStatus('‚ö†Ô∏è PayPal payment cancelled. You can try again anytime.');
            }
            
          }).render('#paypal-button-container');
          
          paypalButtonsRendered = true;
          console.log('‚úÖ PayPal buttons rendered');
          
        } else if (!window.paypal) {
          // Show fallback button if PayPal SDK not loaded
          document.getElementById('paypalFallback').style.display = 'block';
          console.warn('‚ö†Ô∏è PayPal SDK not loaded, showing fallback');
        }
        
      } catch (error) {
        console.error('‚ùå PayPal initialization failed:', error);
        document.getElementById('paypalFallback').style.display = 'block';
      }
    }

    // Stripe payment functionality
    async function processStripePayment() {
      if (!connectedWallet) {
        alert('üîå Please connect your wallet first');
        return;
      }
      
      if (!stripe) {
        showStatus('‚ùå Stripe not available');
        return;
      }
      
      try {
        showStatus('üü° Creating Stripe checkout session...');
        
        const response = await fetch('/api/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            walletAddress: connectedWallet,
            connectedWalletType: connectedWalletType,
            amount: 3333, // $33.33 in cents
            productName: 'ChaosKey333 Relic'
          })
        });
        
        const { sessionId } = await response.json();
        
        showStatus('üîÑ Redirecting to Stripe checkout...');
        
        // Redirect to Stripe checkout
        const { error } = await stripe.redirectToCheckout({ sessionId });
        
        if (error) {
          throw error;
        }
        
      } catch (error) {
        console.error('‚ùå Stripe payment failed:', error);
        showStatus('‚ùå Stripe payment failed. Please try again.');
      }
    }

    // Check for payment success from URL parameters
    function checkPaymentSuccess() {
      const urlParams = new URLSearchParams(window.location.search);
      const paymentStatus = urlParams.get('payment');
      const gateway = urlParams.get('gateway');
      const sessionId = urlParams.get('session_id');
      
      if (paymentStatus === 'success') {
        if (gateway === 'paypal') {
          showStatus('üéâ PayPal Prime payment successful! Prime Vault Key earned!');
          document.getElementById('primeBadge').classList.remove('hidden');
          document.getElementById('autoMintNotice').classList.remove('hidden');
        } else if (gateway === 'stripe') {
          showStatus('üéâ Stripe payment successful! Preparing to mint relic...');
          document.getElementById('autoMintNotice').classList.remove('hidden');
        }
        
        // Trigger auto-mint for both gateways
        setTimeout(() => {
          triggerAutoMint(gateway, sessionId || 'unknown');
        }, 2000);
        
        // Clear URL parameters
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // Auto-mint trigger functionality
    async function triggerAutoMint(gateway, transactionId) {
      try {
        showStatus('ü§ñ Auto-mint activated! Minting your relic...');
        
        if (!window.ethereum) {
          showStatus('‚ùå MetaMask not detected. Manual minting required.');
          return;
        }
        
        // Connect to wallet if not already connected
        if (!connectedWallet) {
          await connectWallet();
        }
        
        if (!connectedWallet) {
          showStatus('‚ùå Wallet connection required for minting');
          return;
        }
        
        // Smart contract details (you'll need to update these)
        const contractAddress = "0x11AaC98400AB700549233C4571B679b879Ba9f3a";
        const abi = [
          {
            "inputs": [],
            "name": "mintRelic",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
          }
        ];
        
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const contract = new ethers.Contract(contractAddress, abi, signer);
        
        showStatus('‚õΩ Confirming transaction... Please approve in your wallet.');
        
        const tx = await contract.mintRelic();
        showStatus('üîÑ Mining transaction... This may take a few minutes.');
        
        await tx.wait();
        
        const successMessage = gateway === 'paypal_prime' ? 
          'üèÜ Prime Relic minted successfully! You are now a Prime Vault Key holder.' :
          '‚úÖ Relic minted successfully! Welcome to the ChaosKey333 vault.';
          
        showStatus(successMessage);
        
        console.log('‚úÖ Auto-mint successful:', tx.hash);
        
      } catch (error) {
        console.error('‚ùå Auto-mint failed:', error);
        showStatus('‚ùå Auto-mint failed. You can manually mint your relic.');
      } finally {
        document.getElementById('autoMintNotice').classList.add('hidden');
      }
    }

    // Load and display pulse tracker data
    async function loadPulseTracker() {
      try {
        const response = await fetch('/api/pulse-tracker?limit=10');
        const pulseData = await response.json();
        
        document.getElementById('totalTx').textContent = pulseData.stats.totalTransactions;
        document.getElementById('primeTx').textContent = pulseData.stats.primeTransactions;
        document.getElementById('totalRevenue').textContent = `$${pulseData.stats.totalRevenue.toFixed(2)}`;
        document.getElementById('lastPulse').textContent = pulseData.stats.lastPulse ? 
          new Date(pulseData.stats.lastPulse).toLocaleTimeString() : 'None';
        
      } catch (error) {
        console.error('‚ùå Failed to load pulse data:', error);
      }
    }

    // Utility function to show status messages
    function showStatus(message) {
      document.getElementById('statusDisplay').innerHTML = message;
      console.log('üì¢ Status:', message);
    }

    // Event listeners
    document.getElementById('connectWallet').addEventListener('click', connectWallet);
    document.getElementById('stripeBtn').addEventListener('click', processStripePayment);
    document.getElementById('paypalFallback').addEventListener('click', () => {
      showStatus('‚ùå PayPal SDK not loaded. Please refresh the page.');
    });

    // Auto-detect PayPal Prime as default and initialize app
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üî• ChaosKey333 Prime Vault loaded');
      initializeApp();
    });

    // Handle wallet account changes
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', function (accounts) {
        if (accounts.length > 0) {
          connectedWallet = accounts[0];
          document.getElementById('walletStatus').innerHTML = `
            üü¢ Connected: ${connectedWallet.substring(0, 6)}...${connectedWallet.substring(38)}
            <br><small>Type: ${connectedWalletType}</small>
          `;
        } else {
          connectedWallet = null;
          document.getElementById('walletStatus').textContent = 'üîí Please connect your wallet to continue';
        }
      });
    }
  </script>
</body>
</html>