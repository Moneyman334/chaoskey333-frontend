<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FrankensteinVault333</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet">
</head>
<body class="vault">
  <div id="terminalOverlay">Initializing Vault Resurrection...</div>
  <div class="resurrection-container">
    <h1 class="glow">⚡ Frankenstein Vault Resurrection 333 ⚡</h1>
    <p class="pulse">Bass Surge Incoming...</p>
    <img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Frankenstein_Dracula.jpg" alt="Frankenstein" class="frank-img" />
    <audio id="bassDrop" autoplay loop>
      <source src="https://frankenstein333.33.amazonaws.com/resurrect_bass.mp3" type="audio/mp3" />
    </audio>
    <button onclick="resurrect()">⚡ Ignite Vault ⚡</button>
    <button id="connectWallet">🔌 Connect Wallet</button>
    <button id="connectCoinbase" style="background-color: #1652f0; color: white;">🔵 Coinbase Wallet</button>
    <button id="paymentBtn" style="background-color: #6772e5; color: white; font-size: 1.2rem; padding: 15px 25px;">💳 Pay $33.33 & Mint Relic</button>
    <button onclick="testStripeConnection()" style="background-color: #28a745; color: white; margin-top: 10px;">🧪 Test Stripe Connection</button>
    <button onclick="testAllConnections()" style="background-color: #17a2b8; color: white; margin-top: 10px;">🔄 Test All Connections</button>
    <button id="mint-button">⚙️ Mint Relic</button>
    
    <!-- NEW SPECTRAL DECODE FEATURES -->
    <div style="margin-top: 20px; border-top: 2px solid #00ff88; padding-top: 15px;">
      <h3 style="color: #00ff88; text-shadow: 0 0 5px #00ff88; margin-bottom: 10px;">⚡ SPECTRAL DECODE FEATURES ⚡</h3>
      <button onclick="toggleSpectralHUD()" style="background-color: #00ff88; color: #000; font-weight: bold; margin: 5px;">🔍 Spectral Decode HUD (H)</button>
      <button onclick="demoToastSystem()" style="background-color: #ff6600; color: white; font-weight: bold; margin: 5px;">🎬 Demo Toast System</button>
      <button onclick="triggerEvolutionDemo()" style="background-color: #8800ff; color: white; font-weight: bold; margin: 5px;">🧬 Demo Evolution Flow</button>
      <div style="margin-top: 8px; font-size: 0.8rem; color: #00ffff;">
        🎯 Press 'H' to toggle Spectral HUD | View glyph↔whisper alignments | Trigger evolution when decode completes
      </div>
    </div>
    
    <div id="mint-status">🔒 Awaiting connection & payment...</div>
    <div id="mintStatus">🔒 Connect wallet, then complete Stripe payment to mint vault relic</div>
    <div style="margin-top: 15px; font-size: 0.9rem; color: #ffaa00;">
      💡 Connect Wallet (MetaMask/Coinbase) → Complete Stripe Payment → Relic Mints to Vault
    </div>
    <div style="margin-top: 10px; font-size: 0.8rem; color: #888;">
      🔌 No wallet? Install: <a href="https://metamask.io" target="_blank" style="color: #ff6600;">MetaMask</a> | <a href="https://wallet.coinbase.com" target="_blank" style="color: #1652f0;">Coinbase Wallet</a>
    </div>
  </div>

  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="components/ToastPop.js"></script>
  <script src="components/SpectralDecodeHUD.js"></script>
  <script src="script.js"></script>

  <script>
    async function connectWallet() {
      if (!window.ethereum) {
        alert("🦊 MetaMask not detected. Please install it.");
        return;
      }

      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        window.walletAddress = accounts[0];
        document.getElementById("mint-status").innerText = `🟢 Wallet Connected: ${window.walletAddress}`;
      } catch (err) {
        alert("⚠️ Wallet connection failed.");
      }
    }

    async function sendMintRequest() {
      if (!window.walletAddress) {
        alert("⚠️ Please connect your wallet first.");
        return;
      }

      document.getElementById("mint-status").innerText = "⏳ Sending mint request...";

      fetch("/api/mint", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet: window.walletAddress })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById("mint-status").innerText = `🎉 Relic minted! Tx: ${data.txHash}`;
          alert(`✅ Mint Successful!\nTransaction: ${data.txHash}`);
        } else {

<script>
  window.addEventListener("load", async () => {
    if (typeof window.ethereum === "undefined") {
      alert("🦊 MetaMask not detected. Please install the extension.");
      return;
    }

    try {
      const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
      window.walletAddress = accounts[0];
      console.log("✅ Wallet Connected:", window.walletAddress);
    } catch (err) {
      console.error("❌ Connection error:", err.message);
    }
  });
</script>

          throw new Error(data.error);
        }
      })
      .catch(err => {
        document.getElementById("mint-status").innerText = "❌ Mint failed";
        alert(`❌ Error: ${err.message}`);

<script>
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get("success") === "true") {
    window.addEventListener('load', mintRelic); // 👈 Triggers mint on load
  }
</script>

      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      connectWallet(); // Auto-trigger wallet connection
      document.getElementById("mint-button").addEventListener("click", sendMintRequest);
    });
  </script>

<script>
  async function mintRelic() {
    const contractAddress = "0x1234567890abcdef1234567890abcdef12345678"; // Use your actual deployed Goerli contract address
    const abi = [
      {
        "inputs": [],
        "name": "mintRelic",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    if (!window.ethereum) {
      alert("⚠️ MetaMask not detected.");
      return;
    }

    try {
      await window.ethereum.request({ method: 'eth_requestAccounts' });

      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      const contract = new ethers.Contract(contractAddress, abi, signer);

      const tx = await contract.mintRelic();
      await tx.wait();

      alert("✅ Relic minted successfully! You're officially part of the ChaosKey Syndicate.");
    } catch (err) {
      console.error("❌ Mint failed:", err);
      alert("Minting failed. Double-check wallet & gas.");
    }
  }

  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get("success") === "true") {
    mintRelic();
  }
</script>
</body>
</html>

<button id="checkout">Mint ChaosKey Relic</button>

<script>
  fetch('/config')
  .then(response => response.json())
  .then(config => {
    if (config.publicKey) {
      const stripe = Stripe(config.publicKey);
    } else {
      console.error("Stripe public key not found in config.");
    }
  })
  .catch(err => console.error("Error loading Stripe config:", err));

  document.getElementById("checkout").addEventListener("click", async () => {
    const res = await fetch("/create-checkout-session", { method: "POST" });
    const session = await res.json();
    await stripe.redirectToCheckout({ sessionId: session.id });
  });

  // ⚡ NEW SPECTRAL DECODE FUNCTIONS ⚡
  
  function toggleSpectralHUD() {
    if (window.spectralHUD) {
      window.spectralHUD.toggle();
    } else {
      console.warn('SpectralDecodeHUD not initialized');
    }
  }
  
  function demoToastSystem() {
    if (window.ToastPop) {
      window.ToastPop.demo();
    } else {
      console.warn('ToastPop not initialized');
    }
  }
  
  async function triggerEvolutionDemo() {
    try {
      // Show the HUD first
      if (window.spectralHUD) {
        window.spectralHUD.show();
        
        // Force decode completion after a short delay to demo the flow
        setTimeout(() => {
          window.spectralHUD.forceDecodeComplete();
        }, 3000);
      }
      
      // Show initial toast
      if (window.ToastPop) {
        window.ToastPop.showInfo('Demo Evolution Flow Starting...');
      }
      
    } catch (error) {
      console.error('Error in evolution demo:', error);
      if (window.ToastPop) {
        window.ToastPop.showError('Demo failed: ' + error.message);
      }
    }
  }
  
  // Initialize new components when page loads
  document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Initializing Spectral Decode components...');
    
    // Components are auto-initialized by their respective scripts
    setTimeout(() => {
      if (window.spectralHUD && window.ToastPop) {
        console.log('✅ All Spectral Decode components ready');
        window.ToastPop.showSuccess('Spectral Decode System Online', 2000);
      }
    }, 1000);
  });

</script>