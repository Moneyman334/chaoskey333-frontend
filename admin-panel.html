<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üõ°Ô∏è Admin Control Panel - ChaosKey333</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #0f0f23, #1a1a2e, #16213e);
      color: #fff;
      font-family: 'Orbitron', monospace;
      min-height: 100vh;
      padding: 20px;
    }

    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #ef4444;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
    }

    .admin-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #ef4444;
    }

    .admin-header h1 {
      color: #ef4444;
      font-size: 2.5em;
      text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
      margin-bottom: 10px;
    }

    .admin-header .warning {
      color: #f59e0b;
      font-size: 1.1em;
      font-weight: bold;
    }

    .auth-section {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .auth-section h3 {
      color: #ef4444;
      margin-bottom: 15px;
    }

    .auth-form {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .auth-form input {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #4b5563;
      border-radius: 5px;
      padding: 10px;
      color: #fff;
      font-family: 'Orbitron', monospace;
      min-width: 200px;
    }

    .auth-form input:focus {
      outline: none;
      border-color: #ef4444;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
    }

    .btn {
      background: linear-gradient(45deg, #ef4444, #dc2626);
      border: none;
      color: white;
      padding: 12px 25px;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Orbitron', monospace;
      font-weight: bold;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn.kill-switch {
      background: linear-gradient(45deg, #dc2626, #991b1b);
      font-size: 1.2em;
      padding: 15px 30px;
      animation: pulse-red 2s infinite;
    }

    .btn.secondary {
      background: linear-gradient(45deg, #6b7280, #4b5563);
    }

    .btn.success {
      background: linear-gradient(45deg, #10b981, #059669);
    }

    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 30px;
      margin-bottom: 30px;
    }

    .control-panel {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 20px;
    }

    .control-panel h3 {
      color: #4ade80;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .status-display {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
      padding: 15px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 5px;
      border-left: 3px solid #4ade80;
      background: rgba(74, 222, 128, 0.1);
    }

    .status-item.error {
      border-left-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .status-item.warning {
      border-left-color: #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }

    .event-log {
      background: rgba(0, 0, 0, 0.7);
      border-radius: 5px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .log-entry {
      margin-bottom: 8px;
      padding: 5px;
      border-left: 3px solid #4ade80;
      background: rgba(74, 222, 128, 0.05);
    }

    .log-entry.error {
      border-left-color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .log-timestamp {
      color: #6b7280;
      font-size: 0.8em;
    }

    .hidden {
      display: none !important;
    }

    .emergency-section {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(153, 27, 27, 0.2));
      border: 2px solid #ef4444;
      border-radius: 10px;
      padding: 25px;
      text-align: center;
      animation: glow-red 3s infinite;
    }

    @keyframes glow-red {
      0%, 100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.5); }
      50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.8); }
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .metric-card {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
    }

    .metric-value {
      font-size: 2em;
      font-weight: bold;
      color: #4ade80;
      display: block;
    }

    .metric-label {
      font-size: 0.9em;
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <h1>üõ°Ô∏è ADMIN CONTROL PANEL</h1>
      <div class="warning">‚ö†Ô∏è RESTRICTED ACCESS - AUTHORIZED PERSONNEL ONLY ‚ö†Ô∏è</div>
    </div>

    <!-- Authentication Section -->
    <div class="auth-section" id="authSection">
      <h3>üîê Administrator Authentication</h3>
      <div class="auth-form">
        <input type="password" id="adminPassword" placeholder="Enter admin password">
        <button class="btn" onclick="authenticate()">AUTHENTICATE</button>
      </div>
      <div id="authStatus" style="margin-top: 10px; color: #ef4444;"></div>
    </div>

    <!-- Main Control Panel (Hidden until authenticated) -->
    <div id="controlPanel" class="hidden">
      
      <!-- Emergency Kill Switch -->
      <div class="emergency-section">
        <h2>üö® EMERGENCY KILL SWITCH</h2>
        <p style="margin: 15px 0; color: #f59e0b;">
          Immediately halts all recursion monitors and pulse broadcasts.<br>
          Use only for emergency situations or rogue pulse detection.
        </p>
        <button class="btn kill-switch" onclick="executeKillSwitch()">
          üõë KILL ALL PROCESSES
        </button>
        <div id="killSwitchStatus" style="margin-top: 15px;"></div>
      </div>

      <!-- Control Grid -->
      <div class="control-grid">
        
        <!-- System Status Panel -->
        <div class="control-panel">
          <h3>üìä System Status</h3>
          <div class="metrics-grid">
            <div class="metric-card">
              <span class="metric-value" id="activeMonitors">0</span>
              <span class="metric-label">Active Monitors</span>
            </div>
            <div class="metric-card">
              <span class="metric-value" id="totalPulses">0</span>
              <span class="metric-label">Total Pulses</span>
            </div>
            <div class="metric-card">
              <span class="metric-value" id="evolutionCycles">0</span>
              <span class="metric-label">Evolution Cycles</span>
            </div>
            <div class="metric-card">
              <span class="metric-value" id="sseConnections">0</span>
              <span class="metric-label">SSE Connections</span>
            </div>
          </div>
          <div class="status-display">
            <div class="status-item" id="monitorStatus">
              <span>Monitor Status:</span>
              <span>LOADING...</span>
            </div>
            <div class="status-item" id="pulseStreamStatus">
              <span>Pulse Stream:</span>
              <span>CHECKING...</span>
            </div>
            <div class="status-item" id="serverStatus">
              <span>Server Health:</span>
              <span>CHECKING...</span>
            </div>
          </div>
          <button class="btn secondary" onclick="refreshSystemStatus()">üîÑ REFRESH STATUS</button>
        </div>

        <!-- Monitor Controls -->
        <div class="control-panel">
          <h3>üîß Monitor Controls</h3>
          <div style="margin-bottom: 15px;">
            <button class="btn" onclick="startAllMonitors()">‚ñ∂Ô∏è START ALL</button>
            <button class="btn secondary" onclick="stopAllMonitors()">‚è∏Ô∏è STOP ALL</button>
            <button class="btn secondary" onclick="resetAllMonitors()">üîÑ RESET ALL</button>
          </div>
          <div style="margin-bottom: 15px;">
            <button class="btn" onclick="triggerManualPulse()">‚ö° MANUAL PULSE</button>
            <button class="btn" onclick="forceEvolutionCycle()">üß¨ FORCE EVOLUTION</button>
          </div>
          <div>
            <label style="color: #94a3b8;">Pulse Interval (ms):</label>
            <input type="number" id="pulseInterval" value="5000" min="1000" max="30000" 
                   style="width: 100px; margin-left: 10px; background: rgba(0,0,0,0.7); border: 1px solid #4b5563; color: #fff; padding: 5px;">
            <button class="btn secondary" onclick="updatePulseInterval()">UPDATE</button>
          </div>
        </div>

      </div>

      <!-- Event Monitoring -->
      <div class="control-panel">
        <h3>üìú Live Event Log</h3>
        <div style="margin-bottom: 15px;">
          <button class="btn secondary" onclick="clearEventLog()">üóëÔ∏è CLEAR LOG</button>
          <button class="btn secondary" onclick="exportEventLog()">üíæ EXPORT LOG</button>
          <label style="margin-left: 20px;">
            <input type="checkbox" id="autoRefreshLog" checked> Auto-refresh every 2s
          </label>
        </div>
        <div class="event-log" id="adminEventLog">
          <div class="log-entry">
            <div class="log-timestamp">[Loading...]</div>
            <div>Initializing admin event monitoring...</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // Admin Panel Controller
    class AdminPanelController {
      constructor() {
        this.isAuthenticated = false;
        this.eventLogTimer = null;
        this.statusTimer = null;
        this.init();
      }

      init() {
        // Auto-refresh timers
        this.statusTimer = setInterval(() => {
          if (this.isAuthenticated) {
            this.refreshSystemStatus();
          }
        }, 5000);

        this.eventLogTimer = setInterval(() => {
          if (this.isAuthenticated && document.getElementById('autoRefreshLog').checked) {
            this.refreshEventLog();
          }
        }, 2000);
      }

      // Authentication
      async authenticate(password) {
        // Simple auth for demo - in production, use proper JWT/OAuth
        const validPasswords = ['admin123', 'chaos333', 'frankenstein'];
        
        if (validPasswords.includes(password)) {
          this.isAuthenticated = true;
          document.getElementById('authSection').classList.add('hidden');
          document.getElementById('controlPanel').classList.remove('hidden');
          document.getElementById('authStatus').textContent = '';
          
          // Initialize the panel
          await this.refreshSystemStatus();
          await this.refreshEventLog();
          
          this.logAdminEvent('ADMIN_LOGIN', 'Administrator authenticated successfully');
          return true;
        } else {
          document.getElementById('authStatus').textContent = '‚ùå Invalid password';
          return false;
        }
      }

      // Kill Switch - Nuclear option
      async executeKillSwitch() {
        const confirmed = confirm(
          '‚ö†Ô∏è CRITICAL WARNING ‚ö†Ô∏è\n\n' +
          'This will immediately stop ALL recursion monitors, close SSE connections, ' +
          'and halt pulse broadcasting system-wide.\n\n' +
          'This action cannot be undone and may disrupt active user sessions.\n\n' +
          'Are you absolutely certain you want to proceed?'
        );

        if (!confirmed) return;

        const doubleConfirm = prompt(
          'Type "EMERGENCY SHUTDOWN" to confirm the kill switch activation:'
        );

        if (doubleConfirm !== 'EMERGENCY SHUTDOWN') {
          alert('Kill switch activation cancelled - confirmation phrase incorrect');
          return;
        }

        try {
          document.getElementById('killSwitchStatus').innerHTML = 
            '<div style="color: #ef4444;">üö® EXECUTING EMERGENCY SHUTDOWN...</div>';

          // Call kill switch API
          const response = await fetch('/api/admin/kill-switch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              timestamp: new Date().toISOString(),
              reason: 'ADMIN_EMERGENCY_SHUTDOWN' 
            })
          });

          if (response.ok) {
            document.getElementById('killSwitchStatus').innerHTML = 
              '<div style="color: #10b981;">‚úÖ EMERGENCY SHUTDOWN SUCCESSFUL</div>';
            
            this.logAdminEvent('KILL_SWITCH_EXECUTED', 'Emergency shutdown completed successfully');
            
            // Refresh status after 2 seconds
            setTimeout(() => this.refreshSystemStatus(), 2000);
          } else {
            throw new Error(`Server responded with ${response.status}`);
          }

        } catch (error) {
          console.error('Kill switch failed:', error);
          document.getElementById('killSwitchStatus').innerHTML = 
            `<div style="color: #ef4444;">‚ùå KILL SWITCH FAILED: ${error.message}</div>`;
          
          this.logAdminEvent('KILL_SWITCH_FAILED', `Emergency shutdown failed: ${error.message}`);
        }
      }

      // System status refresh
      async refreshSystemStatus() {
        try {
          const response = await fetch('/api/admin/system-status');
          const status = await response.json();

          // Update metrics
          document.getElementById('activeMonitors').textContent = status.activeMonitors || 0;
          document.getElementById('totalPulses').textContent = status.totalPulses || 0;
          document.getElementById('evolutionCycles').textContent = status.evolutionCycles || 0;
          document.getElementById('sseConnections').textContent = status.sseConnections || 0;

          // Update status items
          this.updateStatusItem('monitorStatus', 
            status.monitorActive ? 'ACTIVE' : 'INACTIVE',
            status.monitorActive ? 'success' : 'error'
          );

          this.updateStatusItem('pulseStreamStatus',
            status.pulseStreamActive ? 'CONNECTED' : 'DISCONNECTED',
            status.pulseStreamActive ? 'success' : 'warning'
          );

          this.updateStatusItem('serverStatus',
            status.serverHealthy ? 'HEALTHY' : 'ERROR',
            status.serverHealthy ? 'success' : 'error'
          );

        } catch (error) {
          console.error('Failed to refresh system status:', error);
          this.updateStatusItem('monitorStatus', 'ERROR', 'error');
          this.updateStatusItem('pulseStreamStatus', 'ERROR', 'error');
          this.updateStatusItem('serverStatus', 'ERROR', 'error');
        }
      }

      updateStatusItem(id, text, type) {
        const element = document.getElementById(id);
        if (element) {
          element.querySelector('span:last-child').textContent = text;
          element.className = `status-item ${type}`;
        }
      }

      // Event log refresh
      async refreshEventLog() {
        try {
          const response = await fetch('/api/admin/event-log');
          const events = await response.json();

          const logContainer = document.getElementById('adminEventLog');
          logContainer.innerHTML = '';

          events.slice(0, 20).forEach(event => {
            const entry = document.createElement('div');
            entry.className = `log-entry ${event.level || ''}`;
            entry.innerHTML = `
              <div class="log-timestamp">[${new Date(event.timestamp).toLocaleTimeString()}]</div>
              <div><strong>${event.type}:</strong> ${event.message}</div>
            `;
            logContainer.appendChild(entry);
          });

        } catch (error) {
          console.error('Failed to refresh event log:', error);
        }
      }

      // Control actions
      async startAllMonitors() {
        await this.makeControlRequest('/api/admin/monitors/start', 'Starting all monitors...');
      }

      async stopAllMonitors() {
        await this.makeControlRequest('/api/admin/monitors/stop', 'Stopping all monitors...');
      }

      async resetAllMonitors() {
        await this.makeControlRequest('/api/admin/monitors/reset', 'Resetting all monitors...');
      }

      async triggerManualPulse() {
        await this.makeControlRequest('/api/admin/trigger-pulse', 'Triggering manual pulse...');
      }

      async forceEvolutionCycle() {
        await this.makeControlRequest('/api/admin/force-evolution', 'Forcing evolution cycle...');
      }

      async updatePulseInterval() {
        const interval = document.getElementById('pulseInterval').value;
        await this.makeControlRequest('/api/admin/pulse-interval', 'Updating pulse interval...', {
          interval: parseInt(interval)
        });
      }

      async makeControlRequest(url, message, data = {}) {
        try {
          console.log(message);
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (response.ok) {
            const result = await response.json();
            this.logAdminEvent('CONTROL_ACTION', `${message} - Success`);
            setTimeout(() => this.refreshSystemStatus(), 1000);
          } else {
            throw new Error(`Server responded with ${response.status}`);
          }
        } catch (error) {
          console.error('Control request failed:', error);
          this.logAdminEvent('CONTROL_ERROR', `${message} - Failed: ${error.message}`);
        }
      }

      clearEventLog() {
        document.getElementById('adminEventLog').innerHTML = '';
        this.logAdminEvent('LOG_CLEARED', 'Admin event log cleared');
      }

      exportEventLog() {
        // Simple export to download
        const logEntries = Array.from(document.querySelectorAll('.log-entry')).map(entry => entry.textContent);
        const logData = logEntries.join('\n');
        
        const blob = new Blob([logData], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `admin-log-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        this.logAdminEvent('LOG_EXPORTED', 'Admin event log exported');
      }

      logAdminEvent(type, message) {
        const event = {
          type,
          message,
          timestamp: new Date().toISOString(),
          source: 'ADMIN_PANEL'
        };

        // Add to local log
        const logContainer = document.getElementById('adminEventLog');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `
          <div class="log-timestamp">[${new Date().toLocaleTimeString()}]</div>
          <div><strong>${type}:</strong> ${message}</div>
        `;
        logContainer.insertBefore(entry, logContainer.firstChild);

        // Send to server for persistent logging
        fetch('/api/admin/log-event', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(event)
        }).catch(console.error);
      }
    }

    // Global admin controller
    window.adminController = new AdminPanelController();

    // Global functions for buttons
    function authenticate() {
      const password = document.getElementById('adminPassword').value;
      window.adminController.authenticate(password);
    }

    function executeKillSwitch() {
      window.adminController.executeKillSwitch();
    }

    function refreshSystemStatus() {
      window.adminController.refreshSystemStatus();
    }

    function startAllMonitors() {
      window.adminController.startAllMonitors();
    }

    function stopAllMonitors() {
      window.adminController.stopAllMonitors();
    }

    function resetAllMonitors() {
      window.adminController.resetAllMonitors();
    }

    function triggerManualPulse() {
      window.adminController.triggerManualPulse();
    }

    function forceEvolutionCycle() {
      window.adminController.forceEvolutionCycle();
    }

    function updatePulseInterval() {
      window.adminController.updatePulseInterval();
    }

    function clearEventLog() {
      window.adminController.clearEventLog();
    }

    function exportEventLog() {
      window.adminController.exportEventLog();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'K') {
        e.preventDefault();
        if (window.adminController.isAuthenticated) {
          executeKillSwitch();
        }
      }
    });
  </script>
</body>
</html>